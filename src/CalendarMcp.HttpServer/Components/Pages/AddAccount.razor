@page "/admin/ui/accounts/add"
@rendermode InteractiveServer
@attribute [Authorize]
@using CalendarMcp.Auth
@using CalendarMcp.Core.Models
@using CalendarMcp.HttpServer.BlazorAdmin
@inject IAccountConfigurationService ConfigService
@inject NavigationManager Navigation

<h1 class="mb-4">
    <i class="bi bi-plus-circle me-2"></i>Add Account
</h1>

@if (string.IsNullOrEmpty(_model.Provider))
{
    <h5 class="mb-3">Choose a provider</h5>
    <ProviderPicker OnProviderSelected="OnProviderSelected" SelectedProvider="@_model.Provider" />
}
else
{
    <div class="mb-3">
        <button class="btn btn-outline-secondary btn-sm" @onclick="ClearProvider">
            <i class="bi bi-arrow-left me-1"></i>Change Provider
        </button>
        <span class="badge bg-info text-dark ms-2 fs-6">@GetProviderDisplayName(_model.Provider)</span>
    </div>

    @if (_error is not null)
    {
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle me-1"></i> @_error
        </div>
    }

    @if (_success)
    {
        <div class="alert alert-success">
            <i class="bi bi-check-circle me-1"></i> Account created successfully!
            @if (IsOAuthProvider(_model.Provider))
            {
                <span>
                    <a href="/admin/ui/auth/@_model.Id" class="alert-link">Proceed to authentication</a> to connect this account.
                </span>
            }
        </div>
    }

    <EditForm Model="_model" OnValidSubmit="HandleSubmit" FormName="addAccount">
        <DataAnnotationsValidator />

        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">Account ID</label>
                <InputText class="form-control" @bind-Value="_model.Id" placeholder="e.g., work-account" />
                <ValidationMessage For="() => _model.Id" />
                <div class="form-text">Unique identifier (lowercase, hyphens, underscores)</div>
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">Display Name</label>
                <InputText class="form-control" @bind-Value="_model.DisplayName" placeholder="e.g., Work Account" />
                <ValidationMessage For="() => _model.DisplayName" />
            </div>
        </div>

        @* Provider-specific fields *@
        @switch (_model.Provider.ToLowerInvariant())
        {
            case "microsoft365":
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Tenant ID</label>
                        <InputText class="form-control" @bind-Value="_model.TenantId" placeholder="Azure AD tenant ID" />
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Client ID</label>
                        <InputText class="form-control" @bind-Value="_model.ClientId" placeholder="App registration client ID" />
                    </div>
                </div>
                break;

            case "outlook.com":
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Tenant Type</label>
                        <InputSelect class="form-select" @bind-Value="_model.TenantId">
                            <option value="consumers">consumers (personal accounts only)</option>
                            <option value="common">common (personal + organizational)</option>
                        </InputSelect>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Client ID</label>
                        <InputText class="form-control" @bind-Value="_model.ClientId" placeholder="App registration client ID" />
                    </div>
                </div>
                break;

            case "google":
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Client ID</label>
                        <InputText class="form-control" @bind-Value="_model.ClientId" placeholder="Google Cloud client ID" />
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Client Secret</label>
                        <InputText class="form-control" type="password" @bind-Value="_model.ClientSecret" placeholder="Google Cloud client secret" />
                    </div>
                </div>
                break;

            case "ics":
                <div class="row">
                    <div class="col-md-8 mb-3">
                        <label class="form-label">ICS URL</label>
                        <InputText class="form-control" @bind-Value="_model.IcsUrl" placeholder="https://example.com/calendar.ics" />
                        <ValidationMessage For="() => _model.IcsUrl" />
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Cache TTL (minutes)</label>
                        <InputNumber class="form-control" @bind-Value="_model.CacheTtlMinutes" />
                    </div>
                </div>
                break;

            case "json":
                <div class="mb-3">
                    <label class="form-label">Source</label>
                    <InputSelect class="form-select" @bind-Value="_model.JsonSource">
                        <option value="local">Local file path</option>
                        <option value="onedrive">OneDrive via Microsoft Graph</option>
                    </InputSelect>
                </div>

                @if (_model.JsonSource == "local")
                {
                    <div class="mb-3">
                        <label class="form-label">File Path</label>
                        <InputText class="form-control" @bind-Value="_model.FilePath" placeholder="C:\path\to\calendar.json" />
                    </div>
                }
                else
                {
                    <div class="mb-3">
                        <label class="form-label">OneDrive Path</label>
                        <InputText class="form-control" @bind-Value="_model.OneDrivePath" placeholder="/Apps/calendar-mcp/calendar.json" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Auth Account ID (reuse existing Microsoft credentials)</label>
                        <InputSelect class="form-select" @bind-Value="_model.AuthAccountId">
                            <option value="">-- New credentials --</option>
                            @foreach (var acct in _microsoftAccounts)
                            {
                                <option value="@acct.Id">@acct.DisplayName (@acct.Provider)</option>
                            }
                        </InputSelect>
                    </div>
                    @if (string.IsNullOrWhiteSpace(_model.AuthAccountId))
                    {
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Client ID</label>
                                <InputText class="form-control" @bind-Value="_model.ClientId" placeholder="App registration client ID" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Tenant Type</label>
                                <InputSelect class="form-select" @bind-Value="_model.TenantId">
                                    <option value="consumers">consumers</option>
                                    <option value="common">common</option>
                                </InputSelect>
                            </div>
                        </div>
                    }
                }
                <div class="mb-3">
                    <label class="form-label">Cache TTL (minutes)</label>
                    <InputNumber class="form-control" @bind-Value="_model.JsonCacheTtlMinutes" />
                </div>
                break;
        }

        @* Common fields *@
        <div class="row">
            @if (HasEmailSupport(_model.Provider))
            {
                <div class="col-md-6 mb-3">
                    <label class="form-label">Email Domains (comma-separated)</label>
                    <InputText class="form-control" @bind-Value="_model.Domains"
                               placeholder="@GetDefaultDomainsPlaceholder(_model.Provider)" />
                    <div class="form-text">Used for smart email routing</div>
                </div>
            }
            <div class="col-md-3 mb-3">
                <label class="form-label">Priority</label>
                <InputNumber class="form-control" @bind-Value="_model.Priority" />
                <div class="form-text">Higher = preferred</div>
            </div>
            <div class="col-md-3 mb-3 d-flex align-items-end">
                <div class="form-check">
                    <InputCheckbox class="form-check-input" @bind-Value="_model.Enabled" />
                    <label class="form-check-label">Enabled</label>
                </div>
            </div>
        </div>

        <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary" disabled="@_submitting">
                @if (_submitting)
                {
                    <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                    <span>Creating...</span>
                }
                else
                {
                    <i class="bi bi-plus-circle me-1"></i>
                    <span>Create Account</span>
                }
            </button>
            <a href="/admin/ui" class="btn btn-outline-secondary">Cancel</a>
        </div>
    </EditForm>
}

<div class="mt-4">
    <a href="/admin/ui" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-arrow-left me-1"></i>Back to Dashboard
    </a>
</div>

@code {
    private CreateAccountFormModel _model = new();
    private string? _error;
    private bool _success;
    private bool _submitting;
    private List<AccountInfo> _microsoftAccounts = [];

    protected override async Task OnInitializedAsync()
    {
        await LoadMicrosoftAccountsAsync();
    }

    private async Task LoadMicrosoftAccountsAsync()
    {
        try
        {
            var all = await ConfigService.GetAllAccountsFromConfigAsync();
            _microsoftAccounts = all
                .Where(a => a.Provider is "microsoft365" or "outlook.com")
                .ToList();
        }
        catch
        {
            // Non-critical
        }
    }

    private void OnProviderSelected(string provider)
    {
        _model.Provider = provider;

        // Set default domains for known providers
        _model.Domains = provider switch
        {
            "outlook.com" => "outlook.com, hotmail.com, live.com",
            "google" => "gmail.com",
            _ => ""
        };

        // Set default tenant for outlook.com
        if (provider == "outlook.com")
            _model.TenantId = "consumers";
    }

    private void ClearProvider()
    {
        _model = new CreateAccountFormModel();
        _error = null;
        _success = false;
    }

    private async Task HandleSubmit()
    {
        _error = null;
        _success = false;
        _submitting = true;

        try
        {
            var accountInfo = _model.ToAccountInfo();

            // Server-side validation
            var (idValid, idError) = AccountValidation.ValidateAccountId(accountInfo.Id);
            if (!idValid) { _error = idError; return; }

            var (cfgValid, cfgError) = AccountValidation.ValidateProviderConfig(accountInfo.Provider, accountInfo.ProviderConfig);
            if (!cfgValid) { _error = cfgError; return; }

            await ConfigService.AddAccountAsync(accountInfo);
            _success = true;
        }
        catch (InvalidOperationException ex)
        {
            _error = ex.Message;
        }
        catch (Exception ex)
        {
            _error = $"Unexpected error: {ex.Message}";
        }
        finally
        {
            _submitting = false;
        }
    }

    private static bool IsOAuthProvider(string provider) =>
        provider is "microsoft365" or "outlook.com" or "google";

    private static bool HasEmailSupport(string provider) =>
        provider is "microsoft365" or "outlook.com" or "google";

    private static string GetProviderDisplayName(string provider) => provider switch
    {
        "microsoft365" => "Microsoft 365",
        "outlook.com" => "Outlook.com",
        "google" => "Google",
        "ics" => "ICS Feed",
        "json" => "JSON File",
        _ => provider
    };

    private static string GetDefaultDomainsPlaceholder(string provider) => provider switch
    {
        "microsoft365" => "company.com",
        "outlook.com" => "outlook.com, hotmail.com, live.com",
        "google" => "gmail.com",
        _ => "optional"
    };
}
